<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Custom Entities | KubeOps Documentation </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Custom Entities | KubeOps Documentation ">
    <meta name="generator" content="docfx 2.58.4.0">
    
    <link rel="shortcut icon" href="../images/favicon.png">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc">
    <meta property="docfx:tocrel" content="toc">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="../docs/getting_started.html" title="Documentation">Documentation</a>
                      </li>
                      <li>
                          <a href="../kube-ops/index.html" title="KubeOps Api">KubeOps Api</a>
                      </li>
                      <li>
                          <a href="../kube-ops-testing/index.html" title="KubeOps Testing Api">KubeOps Testing Api</a>
                      </li>
                      <li>
                          <a href="https://github.com/buehler/dotnet-operator-sdk/releases" title="Changelog">Changelog</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <a href="getting_started.html" title="Getting Started" class="">Getting Started</a>
                    </li>
                    <li class="">
                      <a href="features.html" title="Features" class="">Features</a>
                    </li>
                    <li class="">
                      <a href="settings.html" title="Settings" class="">Settings</a>
                    </li>
                    <li class="active">
                      <a href="entities.html" title="Entities" class="active">Entities</a>
                    </li>
                    <li class="">
                      <a href="controller.html" title="Controller" class="">Controller</a>
                    </li>
                    <li class="">
                      <a href="events.html" title="Events" class="">Events</a>
                    </li>
                    <li class="">
                      <a href="finalizer.html" title="Finalizer" class="">Finalizer</a>
                    </li>
                    <li class="">
                      <a href="webhooks.html" title="Webhooks" class="">Webhooks</a>
                    </li>
                    <li class="">
                      <a href="utilities.html" title="Utilities" class="">Utilities</a>
                    </li>
                    <li class="">
                      <a href="commands.html" title="CLI Commands" class="">CLI Commands</a>
                    </li>
                    <li class="">
                      <a href="advanced.html" title="Advanced Topics" class="">Advanced Topics</a>
                    </li>
                    <li class="">
                      <a href="ms_build.html" title="MS Build extensions" class="">MS Build extensions</a>
                    </li>
                    <li class="">
                      <a href="testing.html" title="Testing" class="">Testing</a>
                    </li>
                    <li class="">
                      <a href="templates.html" title="Dotnet New Templates" class="">Dotnet New Templates</a>
                    </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="custom-entities">Custom Entities</h1>

<p>The words <code>entity</code> and <code>resource</code> are kind of interchangeable. It strongly
depends on the context. The resource is the type of an object in kubernetes
which is defined by the default api or a CRD. While an entity is a class
in C# of such a resource. (CRD means &quot;custom resource definition&quot;).</p>
<p>To write your own kubernetes entities, use the interfaces
provided by <code>k8s</code> or use the <a class="xref" href="../kube-ops/KubeOps.Operator.Entities.CustomKubernetesEntity.html">CustomKubernetesEntity</a>.</p>
<p>There are two overloads (<a class="xref" href="../kube-ops/KubeOps.Operator.Entities.CustomKubernetesEntity-1.html">CustomKubernetesEntity&lt;TSpec&gt;</a> and <a class="xref" href="../kube-ops/KubeOps.Operator.Entities.CustomKubernetesEntity-2.html">CustomKubernetesEntity&lt;TSpec, TStatus&gt;</a>) that provide
generics for the <code>Spec</code> and <code>Status</code> resource values.</p>
<p>A &quot;normal&quot; entity does not provide any real value (i.e. most of the time).
Normally you need some kind of <code>Spec</code> to have data in your entity.</p>
<p>The status is a subresource which can be updated without updating the
whole resource and is a flat key-value list (or should be)
of properties to represent the state of a resource.</p>
<h2 id="write-entities">Write Entities</h2>
<p>A custom entity could be:</p>
<pre><code class="lang-csharp">class FooSpec
{
    public string? Test { get; set; }
}

[KubernetesEntity(Group = &quot;test&quot;, ApiVersion = &quot;v1&quot;)]
public class Foo : CustomKubernetesEntity&lt;FooSpec&gt;
{
}
</code></pre><p>Now a CRD for your &quot;Foo&quot; class is generated on build
or via the cli commands.</p>
<p>If you don&#39;t use the <a class="xref" href="../kube-ops/KubeOps.Operator.Entities.CustomKubernetesEntity-1.html">CustomKubernetesEntity&lt;TSpec&gt;</a> base class, you need to - at least - use the appropriate interfaces from <code>k8s</code>:</p>
<ul>
<li><code>KubernetesObject</code></li>
<li><code>IKubernetesObject&lt;V1ObjectMeta&gt;</code></li>
</ul>
<h3 id="ignoring-entities">Ignoring Entities</h3>
<p>There are use-cases when you want to model / watch a custom entity from another
software engineer that are not part of the base models in <code>k8s</code>.</p>
<p>To prevent the generator from creating yamls for CRDs you don&#39;t own, use
the <a class="xref" href="../kube-ops/KubeOps.Operator.Entities.Annotations.IgnoreEntityAttribute.html">IgnoreEntityAttribute</a>.</p>
<p>So as an example, one could try to watch for Ambassador-Mappings with
the following entity:</p>
<pre><code class="lang-csharp">public class MappingSpec
{
    public string Host { get; set; }
}

[IgnoreEntity]
[KubernetesEntity(Group = &quot;getambassador.io&quot;, ApiVersion = &quot;v2&quot;)]
public class Mapping : CustomKubernetesEntity&lt;MappingSpec&gt;
{
}
</code></pre><p>You need it to be a <code>KubernetesEntity</code> and a <code>IKubernetesObject&lt;V1ObjectMeta&gt;</code>, but
you don&#39;t want a CRD generated for it (thus the <code>IgnoreEntity</code> attribute).</p>
<h2 id="rbac">RBAC</h2>
<p>The operator (SDK) will generate the role config for your
operator to be installed. When your operator needs access to
Kubernetes objects, they must be mentioned with the
RBAC attributes. During build, the SDK scans the configured
types and generates the RBAC role that the operator needs
to function.</p>
<p>There exist two versions of the attribute:
<a class="xref" href="../kube-ops/KubeOps.Operator.Rbac.EntityRbacAttribute.html">EntityRbacAttribute</a> and
<a class="xref" href="../kube-ops/KubeOps.Operator.Rbac.GenericRbacAttribute.html">GenericRbacAttribute</a>.</p>
<p>The generic RBAC attribute will be translated into a <code>V1PolicyRole</code>
according to the properties set in the attribute.</p>
<pre><code class="lang-csharp">[GenericRbac(Groups = new []{&quot;apps&quot;}, Resources = new[]{&quot;deployments&quot;}, Verbs = RbacVerb.All)]
</code></pre><p>The entity RBAC attribute is the elegant option to use
dotnet mechanisms. The CRD information is generated out of
the given types and then grouped by type and used RBAC verbs.
If you create multiple attributes with the same type, they are
concatenated.</p>
<pre><code class="lang-csharp">[EntityRbac(typeof(RbacTest1), Verbs = RbacVerb.Get | RbacVerb.Update)]
</code></pre><h2 id="validation">Validation</h2>
<p>During CRD generation, the generated json schema uses the types
of the properties to create the openApi schema.</p>
<p>You can use the various validator attributes to customize your crd:</p>
<p>(all attributes are on properties with the exception of the Description)</p>
<ul>
<li><code>Description</code>: Describe the property or class</li>
<li><code>ExternalDocs</code>: Add a link to an external documentation</li>
<li><code>Items</code>: Customize MinItems / MaxItems and if the items should be unique</li>
<li><code>Lenght</code>: Customize the length of something</li>
<li><code>MultipleOf</code>: A number should be a multiple of</li>
<li><code>Pattern</code>: A valid ECMA script regex (e.g. <code>/\d*/</code>)</li>
<li><code>RangeMaximum</code>: The maximum of a value (with option to exclude the max itself)</li>
<li><code>RangeMinimum</code>: The minimum of a value (with option to exclude the min itself)</li>
<li><code>Required</code>: The field is listed in the required fields</li>
<li><code>PreserveUnknownFields</code>: Set the <code>X-Kubernetes-Preserve-Unknown-Fields</code> to <code>true</code></li>
</ul>
<div class="NOTE"><h5>Note</h5><p>For <code>Description</code>: if your project generates the XML documentation files
for the result, the crd generator also searches for those files and a possible
<code>&lt;summary&gt;</code> tag in the xml documentation. The attribute will take precedence though.</p>
</div>
<pre><code class="lang-csharp">public class MappingSpec
{
    /// &lt;summary&gt;This is a comment.&lt;/summary&gt;
    [Description(&quot;This is another comment&quot;)]
    public string Host { get; set; }
}
</code></pre><p>In the example above, the text of the attribute will be used.</p>
<h2 id="multi-version-entities">Multi-Version Entities</h2>
<p>You can manage multiple versions of a CRD. To do this, you can
specify multiple classes as the &quot;same&quot; entity, but with different
versions.</p>
<p>To mark multiple entity classes as the same, use exactly the same
<code>Kind</code>, <code>Group</code> and <code>PluralName</code> and differ in the <code>ApiVersion</code>
field.</p>
<h3 id="version-priority">Version priority</h3>
<p>Sorting of the versions - and therefore determine which version should be
the <code>storage version</code> if no attribute is provided - is done by the kubernetes
rules of version sorting:</p>
<p>Priority is as follows:</p>
<ol>
<li>General Availablility (i.e. <code>V1Foobar</code>, <code>V2Foobar</code>)</li>
<li>Beta Versions (i.e. <code>V11Beta13Foobar</code>, <code>V2Beta1Foobar</code>)</li>
<li>Alpha Versions (i.e. <code>V16Alpha13Foobar</code>, <code>V2Alpha10Foobar</code>)</li>
</ol>
<p>The parsed version numbers are sorted by the highest first, this leads
to the following version priority:</p>
<pre><code>- v10
- v2
- v1
- v11beta2
- v10beta3
- v3beta1
- v12alpha1
- v11alpha2
</code></pre><p>This can also be seen over at the
<a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/#version-priority">kubernetes documentation</a>.</p>
<h3 id="storage-version">Storage Version</h3>
<p>To determine the storage version (of which one, and exactly one must exist)
the system uses the previously mentioned version priority to sort the versions
and picking the first one. To overwrite this behaviour, use the
<a class="xref" href="../kube-ops/KubeOps.Operator.Entities.Annotations.StorageVersionAttribute.html">StorageVersionAttribute</a>.</p>
<div class="WARNING"><h5>Warning</h5><p>when multiple <a class="xref" href="../kube-ops/KubeOps.Operator.Entities.Annotations.StorageVersionAttribute.html">StorageVersionAttribute</a>
are used, the system will thrown an error.</p>
</div>
<p>To overwrite a version, annotate the entity class with the attribute.</p>
<h3 id="example">Example</h3>
<h4 id="normal-multiversion-entity">Normal multiversion entity</h4>
<p>Note that the <code>Kind</code></p>
<pre><code class="lang-csharp">[KubernetesEntity(
    ApiVersion = &quot;v1&quot;,
    Kind = &quot;VersionedEntity&quot;,
    Group = &quot;kubeops.test.dev&quot;,
    PluralName = &quot;versionedentities&quot;)]
public class V1VersionedEntity : CustomKubernetesEntity
{
}

[KubernetesEntity(
    ApiVersion = &quot;v1beta1&quot;,
    Kind = &quot;VersionedEntity&quot;,
    Group = &quot;kubeops.test.dev&quot;,
    PluralName = &quot;versionedentities&quot;)]
public class V1Beta1VersionedEntity : CustomKubernetesEntity
{
}

[KubernetesEntity(
    ApiVersion = &quot;v1alpha1&quot;,
    Kind = &quot;VersionedEntity&quot;,
    Group = &quot;kubeops.test.dev&quot;,
    PluralName = &quot;versionedentities&quot;)]
public class V1Alpha1VersionedEntity : CustomKubernetesEntity
{
}
</code></pre><p>The resulting storage version would be <code>V1VersionedEntity</code>.</p>
<h4 id="overwritten-storage-version-multiversion-entity">Overwritten storage version multiversion entity</h4>
<pre><code class="lang-csharp">[KubernetesEntity(
    ApiVersion = &quot;v1&quot;,
    Kind = &quot;AttributeVersionedEntity&quot;,
    Group = &quot;kubeops.test.dev&quot;,
    PluralName = &quot;attributeversionedentities&quot;)]
[StorageVersion]
public class V1AttributeVersionedEntity : CustomKubernetesEntity
{
}

[KubernetesEntity(
    ApiVersion = &quot;v2&quot;,
    Kind = &quot;AttributeVersionedEntity&quot;,
    Group = &quot;kubeops.test.dev&quot;,
    PluralName = &quot;attributeversionedentities&quot;)]
public class V2AttributeVersionedEntity : CustomKubernetesEntity
{
}
</code></pre><p>The resulting storage version would be <code>V1AttributeVersionedEntity</code>.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/buehler/dotnet-operator-sdk/blob/master/docs/docs/entities.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            © Copyright 2021 Christoph Bühler
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
